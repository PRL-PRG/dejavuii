---
title: "npm-summary"
output:
  html_notebook:
    df_print: kable
---

```{r,echo=F}
DROOT = "/data/dejavuii/full-verified"
source("helpers.R")
```

This notebook shows the analysis of npm modules created by the `npm-summary` command and its friends. 

## NPM Packages Summary

The summary table contains info about unique paths from all projects and splits them into npm and non-npm paths. 

```{r}
psum = readDataset("npm-summary.csv")
LOG("Total projects", d = nrow(psum))
LOG("With NPM files", d = nrow(psum %>% filter(numNPMPaths > 0)), pct = nrow(psum))
```

Since the other columns in the summary table are only approximations, we are not going to deal with them. Their more fine grained and non approximative versions are calculated from the details below. 

```{r, echo = F}
remove("psum")
```

## Package Details

The package details table contains information about packages found in projects. For each tuple (projectId,packagePath) it contains a record summarizing the lifetime of that package. 

```{r}
pds = readDataset("npm-summary-details.csv")
pds$name = factor(pds$name)
LOG("Total number of records", d = nrow(pds))
LOG("Unique packages", d = length(levels(pds$name)))
```

We can have a look at the package frequencies now:

```{r}
x = pds %>% group_by(name) %>% summarize(count = n())
h = hist(x$count, breaks = 100, plot = F)
h$counts =log10(h$counts + 1)
plot(h, ylab="log10(Frequency)")
DT::datatable(x %>% arrange(desc(count)) %>% top_n(100) %>% mutate(url = npmPackageUrl(name)) %>% select(url,count), escape = F)
```

Ok, next step is to remove data that are not interesting:

```{r}
x = pds %>% filter(numVersions != 0)
LOG("No package.json present", d = nrow(pct) - nrow(x), pct = nrow(pds))
x = x %>% filter(numManualChanges > 0)
LOG("Manual changes", d = nrow(x), pct = nrow(pds))
```




```{r}
npmSummary = dRead("npm-summary.csv")
p = dRead("projects.csv")
p$url = paste0("http://github.com/", p$user, "/", p$repo)
#npm = dRead("npmModulesCounts.csv")
npmSummary = merge(p, npmSummary, by.x = "#projectId", by.y = "projectId")

```

```{r}
withNPM = npmSummary %>% filter(numNPMPaths > 0)
withNPMChanges = withNPM %>% filter(npmChanges > 0)
withNPMDeletions = withNPM %>% filter(npmDeletions > 0)
withPossiblyAllDeleted = withNPM %>% filter(npmDeletions >= numNPMPaths)
```

```{r}
summary(withNPMChanges$npmChanges)
```

Package Details

```{r}
pds = dRead("npm-summary-details.csv")
pdsBackup = pds
packageRecords = nrow(pds)
packageRecords
```

Ok, so we have `43804991` entries. First separate those with 0 versions, because they are likely not created via `npm` automatically (0 versions means we have not seen their `package.json` files).

```{r}
nopjsons = pds %>% filter(numVersions == 0)
pds = pds %>% filter(numVersions > 0)
cat(paste("Missing packahe.json ",nrow(nopjsons), ", %:", nrow(nopjsons)/packageRecords))
```

Ok, these out of the way, we can start calculating interesting stuff, starting with looking at how many of the node modules do not survive till today (i.e. they were completely deleted at some point and not introduced again):

```{r}
deletedNPMs = pds %>% filter(numActiveFiles == 0)
cat(paste("Deleted NPMs ",nrow(deletedNPMs), ", %:", nrow(deletedNPMs)/packageRecords))
pds = pds %>% filter(numActiveFiles != 0)
```

Ok, that's interesting. How many projects is that? 

```{r}
x = deletedNPMs %>% group_by(projectId) %>% summarize(count=n())
nrow(x)
```

That's not tiny number. Good. Are there any projects that have deleted *some* node_modules, but not all? 

```{r}
y = pds %>% group_by(projectId) %>% summarize(count=n())
z = inner_join(x, y, by = c("projectId"))
nrow(z)
```

Interesting... We'll get back to these soon. Now back to the packages. Now let's see their versions

```{r}
summary(pds$numVersions)
summary(pds$numManualChanges)
summary(pds$numDeletions)
```

So very few updated and deletions indeed, with some really weird outliers. Similar stuff goes for version updates. Let's get the boring ones out of the way, i.e. no version changes, no manual updates, no manual deletions:

```{r}
boring = pds %>% filter(numVersions == 1 & numManualChanges == 0 & numDeletions == 0)
cat(paste("1 version, no changes, no deletions ",nrow(boring), ", %:", nrow(boring)/packageRecords), "\n")
pds = pds %>% filter(numVersions > 1 | numManualChanges > 0 | numDeletions > 0)
cat(paste("more versions, changes or deletions ",nrow(pds), ", %:", nrow(pds)/packageRecords), "\n")
```

Yeah... Kinda as expected. Vast majority is not interesting, to sum up so far:

- 32% of the packages ever included are deleted at some point
- 63% of the packages are never updated, never deleted, never nothing
- 3% of the packages are updated, or manually changed

So these 3%. How many are actually not manually touched at all:

```{r}
noManual = pds %>% filter(numManualChanges == 0 & numDeletions == 0)
cat(paste("more versions, no manual changes ",nrow(noManual), ", %:", nrow(noManual)/packageRecords), "\n")
pds = pds %>% filter(numManualChanges > 0 | numDeletions > 0)
cat(paste("manual changes ",nrow(pds), ", %:", nrow(pds)/packageRecords), "\n")
```

Let's look at the stats again:

```{r}
summary(noManual$numVersions)
summary(pds$numVersions)
summary(pds$numManualChanges)
summary(pds$numDeletions)
hist(noManual$numVersions, breaks = 31)
```

And now, let's look at project numbers again:

```{r}
ip = pds %>% group_by(projectId) %>% summarize(count=n())
nrow(ip)
```

Ok, that's not that many projects. What we can do now is calculate a dataset that will have *all* entries from the interesting projects

```{r}
ipAll = pdsBackup %>% filter(projectId %in% ip$projectId)
cat(paste("packages in interesting projects ",nrow(ipAll), ", %:", nrow(ipAll)/packageRecords), "\n")
```

So that's about 13% of package records... Ok. 



```{r}
ipx = pdsBackup %>% group_by(projectId) %>% summarize(count=n())
nrow(ipx)

```

# -------------------------------------------------------------------------------------------------

```{r}
summary(pds$numManualChanges)
summary(pds$numManualChangesOriginal)
```

```{r}
summary(pds$numChangedFiles)
summary(pds$numChangedFilesOriginal)
summary(pds$numDeletedFiles)
```

```{r}
summary(pds$numChangingCommits)
summary(pds$numChangingCommitsOriginal)
```

Let's now look only at those that have some manual changes in them, not just deletions. 

```{r}
manualChanges = pds %>% filter(numManualChanges > 0)
cat(paste("Packages with manual changes ",nrow(manualChanges), ", %:", nrow(manualChanges)/packageRecords), "\n")
manualDeletions = pds %>% filter(numDeletions > 0)
cat(paste("Packages with manual deletions ",nrow(manualDeletions), ", %:", nrow(manualDeletions)/packageRecords), "\n")
```

Ok, so we have 10times more deletions than we have changes. Let's look at the changes alone:

```{r}
summary(manualChanges$numManualChanges)
summary(manualChanges$numManualChangesOriginal)
summary(manualChanges$numChangedFiles)
summary(manualChanges$numChangedFilesOriginal)
summary(manualChanges$numChangingCommits)
summary(manualChanges$numChangingCommitsOriginal)
```

Out of curiosity what is the percentage of packages that have changes to unique contents? 

```{r}
manualOriginalChanges = manualChanges %>% filter(numManualChangesOriginal > 0)
cat(paste("Packages with unique manual changes ",nrow(manualOriginalChanges), ", %:", nrow(manualOriginalChanges) /packageRecords), "\n")
```





```{r}
summary(pds$numManualChanges)
x = pds %>% filter(numManualChanges > 1)

```


```{r}
summary(x$numManualChanges)
nrow(x)

```