---
title: "npm-summary"
output:
  html_notebook:
    df_print: kable
---

Previous step: verify
Next step: npm-filter

```{r,echo=F}
DROOT = "/data/dejavuii/data-verified"
source("helpers.R")
```

At git commit `30bca23ae16aa6c504ec1b0997b2f2b762f0c826`:

```
peta@prl1e:~/devel/dejavuii/build$ time ./dejavu npm-summary -d=/data/dejavuii/data-verified            
OH HAI CAN I HAZ DEJAVU AGAINZ?                                                                         
Loading paths...                                                                                        
    303285295 total paths read                                                                          
    184777451 retained paths                                                                            
Loading projects ...                                                                                    
    3424545 total projects read                                                                         
Loading commits ...                                                                                     
    44829020 total commits read                                                                         
Loading commit parents ...                                                                              
Loading file changes ...                                                                                
    1749740633 total changes read                                                                       
    118437459 unique files                                                                              
Calculating project summaries...                                                                        
Calculating project NPM details                                                                         
KTHXBYE!00                                                                                              
                                                                                                        
real    241m19.192s                                                                                     
user    224m10.276s                                                                                     
sys     17m7.413s           
```

This notebook shows the analysis of npm modules created by the `npm-summary` command and its friends. 

> Note that some of the analysis is done manually so reruning the notebook on different data will give you different results, but won't change the manual analysis.  

## NPM Packages Summary

The summary table contains info about unique paths from all projects and splits them into npm and non-npm paths. 

```{r}
psum = readDataset("npm-summary.csv")
LOG("Total projects", d = nrow(psum))
LOG("With NPM files", d = nrow(psum %>% filter(numNPMPaths > 0)), pct = nrow(psum))
```

Since the other columns in the summary table are only approximations, we are not going to deal with them. Their more fine grained and non approximative versions are calculated from the details below. 

```{r, echo = F}
remove("psum")
```

## Package Details

The package details table contains information about packages found in projects. For each tuple (projectId,packagePath) it contains a record summarizing the lifetime of that package. 

```{r}
pds = readDataset("npm-summary-details.csv")
pds$name = factor(pds$name)
LOG("Total number of records", d = nrow(pds))
LOG("Unique packages", d = length(levels(pds$name)))
```

We can have a look at the package frequencies now:

```{r}
x = pds %>% group_by(name) %>% summarize(count = n())
h = hist(x$count, breaks = 100, plot = F)
h$counts =log10(h$counts + 1)
plot(h, ylab="log10(# of packages)", xlab = "# of times the package is included", main = "How often is a package included")
DT::datatable(x %>% arrange(desc(count)) %>% head(100) %>% mutate(url = A(name, npmPackageUrl(name))) %>% select(url,count), escape = F)
```

Ok, next step is to remove data that make sense:)  

First we remove those records, where we haven't seen any package.json. This means that it is not a proper NPM package, therefore any changes to it are ok, since we are interested in changes to NPM packages alone. 

```{r}
x = pds %>% filter(numVersions != 0)
LOG("No package.json present", d = nrow(pds) - nrow(x), pct = nrow(pds))
```

Second, it might be interesting to see what happens to the files in the remaining packages. For this we exclude two groups of packages. Those that were *never* touched in any way after they were included and those that were actually completely deleted. 

```{r}
x = pds %>% filter(numVersions == 1 & numManualChanges == 0 & numDeletions == 0)
LOG("No changes at all", d = nrow(x), pct = nrow(pds))
x = pds %>% filter(numActiveFiles == 0 & numVersions > 0)
LOG("Entirely removed", d = nrow(x), pct = nrow(pds))
```

Now the entirely removed number of packages is not that informative on its own, but we can look at this from the point of projects, i.e. how many unique projects store their npm files and how many of these delete *all* their npm_modules, since these have most likely included them by mistake anyways... (?)

```{r}
# get all projects
projsAll = pds %>% filter(numVersions != 0) %>% group_by(projectId) %>% summarise(packages = n())
# get all projects that delete at least one package
projsDeleted = pds %>% filter(numVersions != 0 & numActiveFiles == 0) %>% group_by(projectId) %>% summarise(deleted = n())
# join them
projs = merge(projsAll, projsDeleted, by="projectId", all = T)
projs$deleted[is.na(projs$deleted)] = 0
projs$survived = projs$packages - projs$deleted
projs$projectName = projectName(projs$projectId)
projs$projectUrl = projectUrl(projs$projectId)
LOG("Projects which delete all packages", d = nrow(projs %>% filter(survived == 0)), pct = nrow(projs))
```

We can also look at the projects that deleted the most, but not all packages:

```{r}
DT::datatable(projs %>% filter(survived > 0, deleted > 0) %>% arrange(desc(deleted / packages)) %>% head(100) %>% mutate(url = A(projectName, projectUrl), pctDeleted = deleted * 100 / packages ) %>% select(url,packages, deleted, survived, pctDeleted), escape = F)
```

Ok. I've looked at some randomly, the one surviving package was not in node_modules folder, but elsewhere. This makes sense.

Now let's look at the number of versions of the packages we see, counting only those with no manual changes - here it is basically an update to the node package stored in the repo:

```{r}
x = pds %>% filter(numVersions > 0 & numManualChanges == 0 & numDeletions == 0)
LOG("No manual changes", d = nrow(x), pct = nrow(pds))
summary(x$numVersions)
h = hist(x$numVersions, breaks = max(x$numVersions), plot = F)
h$counts =log10(h$counts + 1)
plot(h, ylab="log10(# of packages)", xlab = "# of versions", main = "How many versions packages have?")
```

Let's see the packages with most version changes now:

```{r}
DT::datatable(x %>% arrange(desc(numVersions)) %>% head(100) %>% mutate(url = A(projectName(projectId), projectUrl(projectId))) %>% select(projectId, url,path,name, numVersions), escape = F)
```

the vforge-atom, which is almost all of the table is someone's private configuration for atom, where he archives the packages his atom uses apparently. 

The second one is a repo that includes node_modules folder my mistake I assume, that was reasonably actively developed over the time. A few other packages were also updated there, which seems reasonable:

```{r}
DT::datatable(x %>% filter(projectId == 1097718) %>% arrange(desc(numVersions)) %>% head(100) %>% mutate(url = A(projectName(projectId), projectUrl(projectId))) %>% select(url,path,name, numVersions), escape = F) 
DT::datatable(x %>% filter(projectId == 2768321) %>% arrange(desc(numVersions)) %>% head(100) %>% mutate(url = A(projectName(projectId), projectUrl(projectId))) %>% select(url,path,name, numVersions), escape = F) 
```

Now that we know most of the packages are never touched, let's actually see those that are touched manually:

```{r}
x = pds %>% filter(numVersions > 0 & numDeletions > 0)
LOG("Manual deletions", d = nrow(x), pct = nrow(pds))
x = pds %>% filter(numVersions > 0 & numManualChanges > 0)
LOG("Manual changes", d = nrow(x), pct = nrow(pds))
```

Ok, only tiny tiny part of the dataset ever gets manually changed, the next section looks into more details in these alone: 

## Manual analysis of manual changes

Now, we load the manual changes, randomly select a few and then analyze them. 

```{r}
manualChanges = readDataset("npm-summary-manualChanges.csv")
manualChangesSample = manualChanges %>% sample_n(20)
```

Here is the table of manual findigs (this was manually done on randomly selected projects and therefore cannot be reproduced automatically):

row|project|file|Comments
---|-------|----|--------
1  |hopeatina/hiw              |node_modules/express/node_modules/connect/lib/proto.js                                   |~5000 changed files, likely not by hand
2  |greebowarrior/nessa        |server/node_modules/nodetv-movies/index.js                                               |private package
3  |noneedsystem/testing       |node_modules/locomotive/bin/lcm.js                                                       |~800 changes, looks like code formatting only
4  |mercmobily/hotplate        |node_modules/hotDojoStores/client/AppStoreNotify.js                                      |likely private
5  |karenpeng/myvoxel          |node_modules/voxel-engine/node_modules/voxel-control/index.js                            |manual change, did introduce debugging comments before, this removes them
6  |lauren/open-in-spotify     |node_modules/mocha/node_modules/growl/test.min.js                                        |95 changes, extra commit to add mocha files, seems to follow growl repo
7  |zhangmhao/life-time-tracker|node_modules/tracker/search/Routine.js                                                   |looks like private package, but a large one, in chinese so I don't properly understand the context
8  |taro-m/scripting-server    |node_modules/uglify-js/lib/parse.js                                                      |copies change from original package
9  |perjansson/yabt            |node_modules/angular2/ts/src/core/application_common_providers.js                        |~1100 changes, likely not by hand
10 |thiq/scripts               |node_modules/economy/index.js                                                            |private
11 |geon/progres               |node_modules/progres/index.js                                                            |private
12 |icefox0801/jquery-plugin   |node_modules/grunt/node_modules/findup-sync/node_modules/lodash/dist/lodash.underscore.js|copies change from original package (likely, its really old)
13 |synchrolabs/synchroserver  |SynchroServer/node_modules/synchro-web/client/controls/web-gridview-wrapper.js           |private
14 |zhangmhao/life-time-tracker|node_modules/tracker/server/AchieveGoal.js                                               |the same chinese guy as above, looks private
15 |sawbones/gameencode        |node_modules/socket.io/node_modules/socket.io-client/lib/io.js                           |likely mirrors changes from package
16 |artoale/karma-brackets     |node/node_modules/karma/lib/server.js                                                    |removed possibly local debug output
17 |mercmobily/hotplate        |node_modules/hotDojoDgridWidgets/lib/hotDojoDgridWidgets.js                              |likely private
18 |mercmobily/bookingdojo     |node_modules/bd/lib/bd.js                                                                |likely private
19 |zhangmhao/life-time-tracker|node_modules/tracker/conf/defaultSettings.json                                           |the chinese guy again, private
20 |duknic/regex-detective     |node_modules/express-stormpath/node_modules/stormpath/docs/karma.conf.js                 |~3100 files, likely not manual

To summarize the table above:

- 10 (50%) are private packages, or suspected private (i.e. not in NPM)
- 4 (20%) are extensive changes to many many files which are likely not manual 
- 4 (20%) are mirroring changes from the original package
- 2 (10%) addition or removal of debug prints

